<!DOCTYPE html>
<html>
<head>
  <title>Interactive Leaflet Map - Grouped Icons & Local Images</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-control-search@3.0.2/dist/leaflet-search.min.css" />

  <style>
    /* Basic map container styling */
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    /* Custom search container styling */
    .search-container {
      position: absolute; /* Position relative to the viewport/map container */
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000; /* Ensure it's above map layers */
      width: 90%; /* Responsive width */
      max-width: 400px; /* Max width for larger screens */
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      font-family: sans-serif;
    }

    /* Custom search input field */
    #custom-search-input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box; /* Include padding in width */
    }

    /* Search results dropdown container */
    #search-results {
        background-color: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 6px 6px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: -1px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        position: absolute;
        width: 100%;
        left: 0;
        box-sizing: border-box;
    }

    /* Individual search result item */
    .search-result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    /* Last item no border */
    .search-result-item:last-child {
        border-bottom: none;
    }

    /* Hover effect for result items */
    .search-result-item:hover {
      background-color: #f0f0f0;
    }

    /* Style for 'No results' message */
    .no-results {
        padding: 10px;
        color: #888;
        font-style: italic;
    }

    /* Hide the default Leaflet search control UI */
    .leaflet-control-search {
        display: none !important;
    }

    /* Style for images within popups */
    .leaflet-popup-content img {
        max-width: 100%; /* Ensure image fits popup width */
        min-width: 150px; /* Larger minimum width for images */
        height: auto;
        margin-top: 10px; /* Add some space above the image */
        border-radius: 4px; /* Optional: round corners */
        display: block; /* Ensure image is block element */
    }
    .leaflet-popup-content {
        min-width: 250px; /* Larger minimum width */
        max-width: 400px; /* Maximum width to prevent excessive sizing */
        width: auto; /* Allow content to determine width */
    }
    /* Override Leaflet's default popup constraints */
    .leaflet-popup {
        max-width: none; /* Remove Leaflet's default max-width */
    }
    .leaflet-popup-content-wrapper {
        padding: 12px; /* Slightly more padding */
    }
  </style>
</head>
<body>
  <div class="search-container">
    <input type="text" id="custom-search-input" placeholder="Search locations..." autocomplete="off" />
    </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/leaflet-control-search@3.0.2/dist/leaflet-search.min.js" defer></script>

  <script defer>
    // Wait for the DOM and external scripts to be fully loaded
    window.onload = function() {

      // --- Configuration ---
      const mapImagePath = 'maps/Mandragora-full-map.jpg'; // UPDATE if needed (relative path)
      const mapBounds = [[0, 0], [4639, 9639]]; // Image dimensions [y, x] or [height, width]
      const initialZoom = -2;
      const searchMinLength = 2;
      const searchResultZoomLevel = 0;
      const defaultMarkerImage = `https://placehold.co/150x100/eee/ccc?text=No+Image`; // Web fallback for popups

      // --- Marker Group Icon Configuration ---
      // Define paths (RELATIVE to the HTML file) for your different pin images
      const iconPaths = {
          default: 'pins/pin.png', // Default icon if group not specified or not found
          // Add more groups and their icon paths here
      };

      // Create Leaflet Icon objects for each group
      const groupIcons = {};
      for (const group in iconPaths) {
          // Basic check if icon path is provided
          if (iconPaths[group]) {
              groupIcons[group] = L.icon({
                  iconUrl: iconPaths[group], // Use the relative path
                  iconSize: [32, 32],       // Adjust size as needed
                  iconAnchor: [16, 32],      // Point of the icon which will correspond to marker's location
                  popupAnchor: [0, -32]     // Point from which the popup should open relative to the iconAnchor
                  // You might want different sizes/anchors per icon type
              });
          } else {
              console.warn(`Icon path not defined for group: ${group}`);
          }
      }
      // Ensure a default icon exists
      if (!groupIcons.default) {
          console.error("Default icon path ('pin/pin-default.png') is missing or invalid. Markers may not appear correctly.");
          // Provide a fallback mechanism if needed, e.g., use Leaflet's default
          groupIcons.default = new L.Icon.Default();
      }

      /* --- Marker Data ---
       * Structure: {
       * name: 'Location Name',
       * coords: [y, x],
       * group: 'groupName', // Corresponds to keys in iconPaths
       * imageUrl?: 'path/to/image.jpg' // RELATIVE path to popup image, or null/omit
       * }
       */
      let markerData = [
        { name: 'Main Gate', coords: [800, 200], group: 'entrance', imageUrl: 'img/example.jpeg' }, 
        { name: 'Center Plaza', coords: [500, 500], group: 'landmark', imageUrl: 'img/example.jpeg' }, 
        { name: 'North Tower', coords: [100, 900], group: 'landmark' }, // No popup image
        { name: 'South Garden', coords: [900, 300], group: 'landmark', imageUrl: 'img/example.jpeg' },
        { name: 'East Wing Shop', coords: [600, 1200], group: 'shop', imageUrl: null }, // Explicitly no image
        { name: 'West Entrance', coords: [700, 100], group: 'entrance' }
        // Add more markers here
      ];
      // --- End Configuration ---


      // --- Map Initialization ---
      const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -5,
        maxZoom: 5
      });

      // Add the image overlay for the map itself
      const image = L.imageOverlay(mapImagePath, mapBounds, {
          errorOverlayUrl: `https://placehold.co/${mapBounds[1][1]}x${mapBounds[1][0]}/EEE/CCC?text=Base+Map+Not+Found`, // Placeholder on error
          alt: 'Map Background Image'
      }).addTo(map);

      // Fit map view to the image bounds
      map.fitBounds(mapBounds);
      map.setZoom(initialZoom);


      // --- Markers Setup ---
      const markerLayer = L.layerGroup();
      const markersMap = new Map();

      // Function to create popup content (modified to remove the Remove button)
      function createPopupContent(name, markerInstance, imageUrl = null) {
          const container = document.createElement('div');
          container.innerHTML = `<b>${name}</b><br>`;

          // Add image if URL (relative path) is provided
          if (imageUrl) {
              const img = document.createElement('img');
              img.src = imageUrl; // Use the relative path directly
              img.alt = name;
              img.onerror = function() { // Fallback if local image fails to load
                  this.onerror=null;
                  this.src=defaultMarkerImage; // Use web placeholder as fallback
                  this.alt='Image not available';
                  console.warn(`Failed to load local image: ${imageUrl}. Using placeholder.`);
              };
              container.appendChild(img);
              container.appendChild(document.createElement('br'));
          }

          return container;
      }

      // Function to add a marker
      function addMarkerToMap(data, isInitial = false) {
          const { name, coords, group = 'default', imageUrl = null } = data; // Destructure data, provide default group

          if (!name || !coords) {
              console.warn("Skipping marker: Missing name or coords.", data);
              return null;
          }

          // Prevent adding duplicate names (case-insensitive)
          if (markersMap.has(name.toLowerCase())) {
              if (!isInitial) alert(`Marker with name "${name}" already exists.`);
              return null;
          }

          // Get the icon for the group, fallback to default
          const markerIcon = groupIcons[group] || groupIcons.default;
          if (!groupIcons[group]) {
              console.warn(`Icon for group "${group}" not found, using default.`);
          }

          const marker = L.marker(coords, {
              icon: markerIcon, // Use the group-specific icon
              title: name
          }).addTo(markerLayer);

          // Create and bind popup content
          marker.bindPopup(createPopupContent(name, marker, imageUrl));

          // Store marker data for search and removal
          marker.feature = { properties: { name: name } }; // For compatibility
          markersMap.set(name.toLowerCase(), marker); // For quick lookup

          console.log(`Marker added: ${name} (Group: ${group}) at ${coords}`);
          return marker;
      }

      // Add initial markers from markerData
      markerData.forEach(item => {
          addMarkerToMap(item, true); // Pass the whole item and true for isInitial
      });

      // Add the layer group to the map
      markerLayer.addTo(map);


      // --- Leaflet Search Control (Initialized but UI Hidden) ---
      // Still useful if you want to leverage its internal search logic potentially
      if (L.Control.Search) {
          const searchControl = new L.Control.Search({
            layer: markerLayer, // Search the dynamic layer
            propertyName: 'name',
            marker: false,
            zoom: searchResultZoomLevel,
            initial: false,
            collapsed: true,
            textPlaceholder: 'Search...',
            moveToLocation: function(latlng, title, mapRef) { }
          });
          // map.addControl(searchControl);
      } else {
          console.warn("Leaflet Control Search library not loaded correctly.");
      }


      // --- Custom Search Implementation ---
      const customSearchInput = document.getElementById('custom-search-input');
      const searchContainer = document.querySelector('.search-container');
      let resultsContainer = null;

      function getResultsContainer() {
          if (!resultsContainer) {
              resultsContainer = document.createElement('div');
              resultsContainer.id = 'search-results';
              searchContainer.appendChild(resultsContainer);
          }
          return resultsContainer;
      }

      function removeResultsContainer() {
          if (resultsContainer) {
              resultsContainer.remove();
              resultsContainer = null;
          }
      }

      customSearchInput.addEventListener('input', function(e) {
        const searchText = e.target.value.trim().toLowerCase();
        const currentResultsContainer = getResultsContainer();
        currentResultsContainer.innerHTML = '';

        if (searchText.length >= searchMinLength) {
          // Filter the CURRENT markerData array
          const matchingMarkers = markerData.filter(item =>
            item.name.toLowerCase().includes(searchText)
          );

          if (matchingMarkers.length > 0) {
            matchingMarkers.forEach(item => { // item here is from markerData
              const resultItem = document.createElement('div');
              resultItem.textContent = item.name;
              resultItem.className = 'search-result-item';

              resultItem.addEventListener('click', function() {
                const marker = markersMap.get(item.name.toLowerCase()); // Find marker instance
                if (marker) {
                  map.setView(marker.getLatLng(), searchResultZoomLevel);
                  marker.openPopup();
                  customSearchInput.value = item.name;
                  removeResultsContainer();
                } else {
                    console.error("Marker data found but marker instance not in map for:", item.name);
                    // Fallback: use coords from data if marker instance is somehow lost
                    map.setView(item.coords, searchResultZoomLevel);
                    removeResultsContainer();
                }
              });
              currentResultsContainer.appendChild(resultItem);
            });
          } else {
            const noResults = document.createElement('div');
            noResults.textContent = 'No locations found';
            noResults.className = 'no-results';
            currentResultsContainer.appendChild(noResults);
          }
        } else {
          removeResultsContainer();
        }
      });

      customSearchInput.addEventListener('keydown', function(e) {
          if (e.key === "Escape") {
              removeResultsContainer();
          }
      });

      document.addEventListener('click', function(e) {
        // Close results if click is outside search container and not on map/popup elements
        const isClickInSearch = searchContainer.contains(e.target);
        const isClickInPopup = e.target.closest('.leaflet-popup');
        // More robust check for click on map (covers controls, markers etc.)
        const isClickOnMapOrChildren = map.getContainer().contains(e.target) && !isClickInPopup && !isClickInSearch;

        if (!isClickInSearch && !isClickInPopup && !isClickOnMapOrChildren) {
             removeResultsContainer();
        }
      });

       customSearchInput.addEventListener('keypress', function(e) {
           if (e.key === 'Enter') {
               e.preventDefault();
               const firstResult = resultsContainer?.querySelector('.search-result-item');
               if (firstResult) {
                   firstResult.click();
               }
           }
       });

    }; // End window.onload
  </script>
</body>
</html>